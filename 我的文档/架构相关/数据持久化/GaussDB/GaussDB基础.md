GaussDB 是华为公司自主研发的分布式关系型数据库，基于开源社区的 PostgreSQL 技术，并在其基础上进行了大量的创新和优化。本文针对 GaussDB (DWS) 8.1.3-ELS 产品进行分析。GaussDB (DWS) 8.1.3-ESL 提供高性能、可扩展的数据仓库服务，支持大规模数据存储和分析。它能够处理PB级别的数据，适用于企业级数据分析、数据挖掘、商业智能等场景。

GaussDB (DWS) 采用 MPP（Massively Parallel Processing，大规模并行处理）架构，这是一种无共享架构（Shared Nothing Architecture），在数据仓库和大规模数据分析场景中具有显著优势。

**MPP 架构**是一种将数据和处理任务分布在多个独立的节点上，每个节点都有自己的处理器、内存和存储系统，通过高速网络连接协同工作的架构。这种架构允许系统通过增加节点数量来线性扩展处理能力和存储容量，非常适合处理大规模数据和高并发查询。

在 GaussDB (DWS) 的 MPP 架构中，每个节点都是独立的，拥有自己的计算和存储资源。数据被划分到不同的节点上，节点之间通过高速网络进行通信和协同计算。这种设计使得系统能够并行处理大量数据，提高查询性能。

GaussDB (DWS) 通过数据分布策略（如哈希分布、范围分布等）将数据均匀地分布在各个节点上，确保每个节点处理的数据量大致相同，从而实现负载均衡。此外，系统会根据查询需求动态调整数据分布和任务分配，进一步优化性能。

GaussDB (DWS) 的 MPP 架构支持高可用性和容错机制。每个节点的数据都有多个副本，分布在不同的节点上。当某个节点发生故障时，系统会自动将任务重新分配到其他节点上，确保数据不丢失和服务不中断。

GaussDB (DWS) 的 MPP 架构具有高度的扩展性和灵活性。用户可以根据业务需求动态增加或减少节点数量，实现资源的弹性伸缩。这种特性使得 GaussDB (DWS) 能够适应不同规模的数据处理需求，从GB级到PB级数据量都能轻松应对。

# 数据库架构

GaussDB (DWS) 由 MPPDBServer(CM) 集群管理器、MPPDBServer 业务处理器和 MPPDBServer(GTM) 全局事务管理器构成

1. MPPDBServer(CM) 集群管理器

**集群管理器（Cluster Manager, CM）** 是 GaussDB (DWS) 的核心管理组件，负责整个集群的资源管理、节点监控、故障恢复和负载均衡等任务，是集群的大脑。CM 分为主、备系统，正常情况下，只有主 CM 提供服务，当主 CM 发生故障才会提升备 CM 为主节点提供服务。

- **资源管理**: 负责集群中各个节点的资源分配和管理，包括 CPU、内存、存储等资源。
- **节点监控**: 实时监控集群中各个节点的状态，包括节点是否在线、负载情况、性能指标等。
- **故障检测与恢复**: 检测节点故障，并自动进行故障恢复，如节点重启、主备切换等，确保集群的高可用性。
- **负载均衡**: 根据各个节点的负载情况，动态调整任务分配，确保集群资源的合理利用。
- **配置管理**: 管理集群的配置参数，如节点数量、节点角色、备份策略等。
- **安全认证**: 提供安全认证机制，确保只有授权用户才能访问集群资源。
- **高可用性**: 通过主备集群架构和自动故障切换机制，确保集群的高可用性。
- **可扩展性**: 支持动态添加或移除节点，实现集群的弹性伸缩。
- **自动化运维**: 提供丰富的运维工具和接口，简化集群管理操作。

2. MPPDBServer 业务处理器

**业务处理器（MPPDBServer）** 是 GaussDB (DWS) 的核心计算组件，负责执行用户提交的 SQL 查询和数据分析任务。每个业务处理器都是一整个独立的小计算集群，拥有自己的处理器、内存和存储系统。

- **SQL 解析与优化**: 解析用户提交的 SQL 语句，并生成最优的执行计划。
- **查询执行**: 根据执行计划并行执行查询任务，利用 MPP 架构的优势，提高查询性能。
- **数据存储与管理**: 管理数据的存储和访问，包括数据分区、索引管理、数据压缩等。
- **事务管理**: 支持事务的 ACID 特性（原子性、一致性、隔离性、持久性），确保数据的一致性和完整性。
- **并行计算**: 利用 MPP 架构的并行计算能力，处理大规模数据和高并发查询。
- **高性能**: 通过并行计算和优化技术，提供高性能的数据处理和分析能力。
- **可扩展性**: 支持横向扩展，可以根据业务需求增加业务处理器节点，提升处理能力。
- **多租户支持**: 支持多租户架构，可以在一个集群中同时运行多个业务，满足不同用户的需求。

3. MPPDBServer(GTM) 全局事务管理器

**全局事务管理器（Global Transaction Manager, GTM）** 是 GaussDB (DWS) 的核心事务管理组件，负责管理分布式事务，确保数据的一致性和完整性。

- **事务协调**: 协调分布式事务的执行，确保所有节点在事务提交或回滚时的一致性。
- **锁管理**: 管理分布式锁，防止数据冲突和脏读。
- **快照隔离**: 提供快照隔离级别，确保事务读取的数据是一致的。
- **故障恢复**: 在发生故障时，确保事务的原子性和持久性。
- **分布式事务支持**: 支持跨多个节点的分布式事务，确保数据的一致性和完整性。
- **高性能**: 通过优化事务处理流程，减少事务开销，提高系统性能。
- **可扩展性**: 支持大规模分布式事务处理，可以根据业务需求扩展事务管理能力。

其中 MPPDBServer 业务处理器又包含了 Coordinator(CN) 与 Datanode(DN)

1. Coordinator（CN，协调节点）

**Coordinator（CN）** 是 GaussDB (DWS) 的协调节点，负责接收用户提交的 SQL 查询，进行查询解析、优化和分发，并协调各个 Datanode 执行任务。

主要功能：

- **SQL 解析**: 接收用户提交的 SQL 语句，并进行语法解析和语义分析。
- **查询优化**: 生成最优的执行计划，包括选择合适的连接方法、索引使用、并行策略等。
- **任务分发**: 将执行计划分解成多个子任务，并分发到相应的 Datanode 上执行。
- **结果汇总**: 收集各个 Datanode 返回的中间结果，进行汇总和最终结果生成。
- **事务管理**: 协调分布式事务的执行，确保事务的 ACID 特性。
- **资源管理**: 管理和分配集群资源，如内存、CPU 等，确保任务能够高效执行。
- **智能优化**: 采用先进的查询优化技术，如基于成本的优化（CBO）、多列统计信息、动态采样等，生成高效的执行计划。
- **并行处理**: 支持并行查询处理，充分利用 MPP 架构的优势，提高查询性能。
- **高可用性**: 通过主备 CN 架构和自动故障切换机制，确保 CN 的高可用性。

2. Datanode（DN，数据节点）

**Datanode（DN）** 是 GaussDB (DWS) 的数据节点，负责实际的数据存储和计算。每个 Datanode 管理一部分数据，并执行 Coordinator 分发的子任务。

主要功能：

- **数据存储**: 存储和管理分配给自己的数据，包括数据分区、索引管理、数据压缩等。
- **数据计算**: 执行 Coordinator 分发的子任务，如过滤、连接、聚合等操作。
- **数据备份与恢复**: 提供数据备份和恢复功能，确保数据的安全性和可靠性。
- **事务处理**: 支持本地事务处理，并与 GTM 协作，确保分布式事务的一致性。
- **数据缓存**: 利用内存缓存热点数据，提高数据访问速度。
- **数据分区**: 支持多种数据分区策略，如哈希分区、范围分区等，均匀分布数据负载。
- **并行计算**: 每个 Datanode 都可以并行执行多个子任务，充分利用多核 CPU 和内存资源。
- **高可用性**: 通过数据多副本和自动故障切换机制，确保数据的高可用性和容错性。

示例架构图

```
+---------------------+
|      Coordinator    |
|  (CN)               |
|                     |
|  - SQL 解析         |
|  - 查询优化         |
|  - 任务分发         |
|  - 结果汇总         |
+----------+----------+
           |
           | 任务分发
           |
+----------v----------+
|      Datanode       |
|  (DN)               |
|                     |
|  - 数据存储         |
|  - 数据计算         |
|  - 数据备份与恢复   |
+---------------------+
```

# 数据库逻辑结构

GaussDB (DWS) 数据库的逻辑结构可以分为以下几个层次：

1. **Tablespace（表空间）**：
   - 表空间是一个目录，用于存储数据库的各种物理文件。一个数据库实例中可以存在多个表空间，每个表空间可以对应多个数据库。
   - 表空间是数据在物理上的存储位置，数据库中的所有对象都存储在表空间中。

2. **Database（数据库）**：
   - 数据库是逻辑上的抽象，用于管理各类数据对象。不同的数据库之间相互隔离。
   - 数据库管理的对象可以分布在多个表空间中。

3. **Datafile Segment（数据文件段）**：
   - 数据文件段通常每张表只对应一个数据文件。如果某张表的数据量较大，则会分为多个数据文件进行存储。
   - 如果某张表的数据大于1GB，则会分为多个数据文件进行存储。

4. **Table（表）**：
   - 表是数据的结构化视图，存储特定类型的数据。每张表只能属于一个数据库，也只能对应到一个表空间。
   - 表对应的数据文件必须在同一个表空间中。

5. **Block（数据块）**：
   - 数据块是数据库管理的基本单位，默认大小为8KB。
   - 数据块是数据存储的最小单位，数据库中的数据以块为单位进行读写操作。

# GaussDB (DWS) 数据请求的查询处理过程

1. 客户端向 Coordinator 申请建立连接
2. Coordinator 验证用户权限
3. 客户端发送查询请求
4. Coordinator 分配服务线程
5. Coordinator 向 GTM 申请全局事务信息
6. GTM 向 Coordinator 返回全局事务信息
7. Coordinator 解析并优化查询指令
8. Coordinator 将查询计划发送给各个 DN
9. DN 节点执行查询并返回结果
10. 关闭连接

# 并发访问

GaussDB (DWS) 基于 MVCC 支持 RR(可重复读) 和 RC(读已提交) 级别，不支持读未提交和串行化事物。

# GaussDB (DWS) 基础

## 创建和管理数据库

GaussDB (DWS) 提供了两个模板数据库，template0 和 template1 以及一个默认的数据库 postgres。默认情况下，每个新建的数据库都是基于一个模板数据库，默认使用 template1 作为模板，编码格式为 SQL_ASCII，且不允许自定义字符编码，若需指定字符集则需使用 template0 数据库。

查询数据库列表：

```sql
select * from pg_database;
```

查询数据库表列表：

```sql
select * from pg_tables;
```

## 创建分布式表

GaussDB (DWS) 支持三种分布方式，复制表、哈希表和轮询表

- 复制表：集群的每个 DN 节点都有一份全量的表，数据冗余较多，适用于数据字典类的小表
- 哈希表：使用hash方式对分布键取模，将数据散列到所有 DN 节点上，推荐 100 W 数据以上的表使用，一般不建议单独新增一列专门用于分布键，尤其是新增自增序列，序列的性能瓶颈得不偿失。
- 轮询表：将每行数据轮询方式分布在所有 DN 节点中，优点是不会发生数据倾斜，缺点是查询性能不如 hash 分布，一般在 hash 分布是无法找到合适的分布键时使用。

## 数据存储模型

GaussDB (DWS) 支持行存储和列存储两种方式

| ID | 姓名   | 年龄 | 城市     |
|----|--------|------|----------|
| 1  | 张三   | 25   | 北京     |
| 2  | 李四   | 30   | 上海     |
| 3  | 王五   | 28   | 广州     |

行存储结构

```
1 张三 25 北京 2 李四 30 上海 ...
```

适合需要查询表的大部分字段数据，表字段个数较少，及频繁进行 CRUD 操作的表

列存储模式：

``` 
1 2 3 张三 李四 王五 25 30 28 ...
```

适合大宽表，查询的列较少，关联，分组和统计分析操作较多的场景

## 数据压缩

数据压缩可选择性开启，对于 I/O 压力大，CPU 较空闲的场景，选择高压缩比降低 I/O 压力，行存表暂不支持压缩，列存表压缩级别：YES/NO/LOW/MIDDLE/HIGH。

# 索引

支持以下索引类型

- B-tree
- gin:倒排索引
- gist:几何索引
- Psort:针对列存表进行局部排序索引








