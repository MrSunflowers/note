# sata

Seata 是一款开源的分布式事务解决方案，旨在在微服务架构下提供高性能和简单易用的分布式事务服务。Seata 提供了四种主要的分布式事务模式，分别是 AT（Automatic Transaction）、TCC（Try-Confirm-Cancel）、SAGA 和 XA 模式。

## 角色

在 Seata 的架构中，主要有三个核心角色：事务协调者（Transaction Coordinator，简称 TC）、事务管理器（Transaction Manager，简称 TM）和资源管理器（Resource Manager，简称 RM）。

### **事务协调者（TC）**

- **定义**：事务协调者是 Seata 的核心组件，负责维护全局和分支事务的状态，协调全局事务的提交或回滚。
- **功能**：
  - **全局事务管理**：TC 负责管理全局事务的整个生命周期，包括事务的开始、提交和回滚。
  - **分支事务协调**：TC 协调各个分支事务的执行状态，确保所有分支事务的一致性。
  - **状态维护**：TC 维护全局事务和分支事务的状态信息，以便在需要时进行恢复或回滚操作。
- **部署方式**：TC 通常作为一个独立的服务端部署，与业务系统分离。

### **事务管理器（TM）**

- **定义**：事务管理器是业务系统的一部分，负责定义全局事务的范围，包括开始全局事务、提交或回滚全局事务。
- **功能**：
  - **事务发起**：TM 负责发起全局事务的请求，通知 TC 开始一个新的全局事务。
  - **事务结束**：TM 在业务逻辑执行完成后，通知 TC 提交或回滚全局事务。
  - **全局事务传播**：TM 负责将全局事务的 XID（事务标识）在微服务调用链中传播，确保多个微服务的事务关联在一起。
- **部署方式**：TM 通常嵌入到业务系统的应用中，作为客户端的一部分。

### **资源管理器（RM）**

- **定义**：资源管理器是业务系统的一部分，负责管理分支事务处理的资源，与 TC 交互以注册分支事务和报告分支事务的状态，并驱动分支事务的提交或回滚。
- **功能**：
  - **资源管理**：RM 管理业务系统中的资源，如数据库连接、消息队列等。
  - **分支事务注册**：RM 将本地事务注册为全局事务的分支事务，通过 XID 与全局事务关联。
  - **状态报告**：RM 向 TC 报告分支事务的执行状态，包括准备提交、提交成功或回滚成功等。
  - **事务驱动**：RM 根据 TC 的指令驱动分支事务的提交或回滚操作。
- **部署方式**：RM 通常嵌入到业务系统的应用中，作为客户端的一部分。

在 Seata 的架构中，TC、TM 和 RM 三个角色协同工作，确保分布式事务的一致性和可靠性。具体流程如下：

1. **全局事务开始**：TM 请求 TC 开始一个新的全局事务，TC 生成一个 XID 作为事务标识。
2. **分支事务注册**：RM 将本地事务注册为全局事务的分支事务，通过 XID 与全局事务关联。
3. **事务执行与状态报告**：RM 执行分支事务，并向 TC 报告执行状态。
4. **全局事务结束**：TM 请求 TC 提交或回滚全局事务，TC 通知所有 RM 进行相应的操作。
5. **事务协调与提交/回滚**：TC 协调所有 RM 的提交或回滚操作，确保全局事务的一致性。

## 模式

### **AT 模式（Automatic Transaction）**

AT 模式是 Seata 最先支持的模式，也被称为自动分支持事务模式。它是一种无侵入的分布式事务解决方案，适用于不希望对业务进行改造的场景。

#### **工作原理**

- **一阶段**：Seata 拦截业务 SQL 语句，解析 SQL 语义，提取表元数据，找到要更新的业务数据。在业务数据被更新前，将其保存成“前镜像”（before image），然后执行 SQL 语句更新业务数据，在业务数据更新后，再将其保存成“后镜像”（after image），最后生成行锁。以上操作全部在一个数据库事务内完成，保证了一阶段操作的原子性。
- **二阶段提交**：如果全局事务是提交状态，Seata 框架只需将一阶段保存的快照数据和行锁删除，完成数据清理即可。
- **二阶段回滚**：如果全局事务是回滚状态，Seata 需要回滚一阶段已经执行的业务 SQL，还原业务数据。回滚方式是用“前镜像”还原业务数据，但在还原前要首先校验“脏写”，对比“数据库当前业务数据”和“后镜像”，如果两份数据完全一致则说明没有脏写，可以还原数据。如果不一致则说明有脏写，需要转人工处理。

#### **工作流程**

**1. 全局事务的开始**

- **事务管理器（TM）** 发起全局事务请求，通知 **事务协调者（TC）** 开始一个新的全局事务。
- **TC** 生成一个全局唯一的 **XID（事务标识符）**，并将其返回给 **TM**。

**2. 一阶段：业务 SQL 执行与快照生成**

- **资源管理器（RM）** 接收到业务 SQL 请求，Seata 拦截并解析 SQL 语句。
- **RM** 在执行 SQL 语句之前，进行以下操作：
  1. **保存“前镜像”（Before Image）**：
     - 记录当前业务数据的原始状态，以便在需要回滚时恢复数据。
  2. **执行 SQL 语句**：
     - 对业务数据进行实际的更新操作。
  3. **保存“后快照”（After Image）**：
     - 记录更新后的业务数据状态。
  4. **生成行锁（Row Lock）**：
     - 对当前操作的数据行加锁，防止其他事务并发修改，确保数据的一致性。
- **RM** 将本地事务注册为全局事务的分支事务，并将执行状态报告给 **TC**。

**3. 一阶段提交**

- **RM** 在完成上述操作后，直接提交本地事务，释放数据库资源。
- **TC** 记录分支事务的执行状态，等待全局事务的最终决定（提交或回滚）。

**4. 二阶段：全局事务提交**

- **TM** 请求 **TC** 提交全局事务。
- **TC** 收到提交请求后，进行以下操作：
  1. **删除快照数据和行锁**：
     - 由于一阶段已经提交，删除之前保存的快照数据和行锁，完成数据清理。
  2. **通知 RM**：
     - **TC** 通知所有相关的 **RM** 提交分支事务。
- **RM** 收到提交指令后，确认本地事务已经提交，无需额外操作。

**5. 二阶段：全局事务回滚**

- **TM** 请求 **TC** 回滚全局事务。
- **TC** 收到回滚请求后，进行以下操作：
  1. **校验脏写（Dirty Write）**：
     - **TC** 对比数据库当前业务数据和“后快照”，如果两份数据完全一致，说明没有脏写，可以进行回滚。
     - 如果数据不一致，说明存在脏写，需要转人工处理。
  2. **执行回滚操作**：
     - **TC** 通知所有相关的 **RM** 回滚分支事务。
     - **RM** 使用“前镜像”还原业务数据，并删除快照数据和行锁。
- **RM** 收到回滚指令后，执行回滚操作，恢复数据到原始状态。

**6. 全局事务结束**

- **TC** 在完成提交或回滚操作后，结束全局事务，释放相关资源。

**示例流程图**

```
1. TM 请求 TC 开始全局事务
2. TC 生成 XID 并返回给 TM
3. RM 拦截业务 SQL，生成前快照，执行 SQL，生成后快照，加行锁
4. RM 注册分支事务到 TC
5. RM 提交本地事务
6. TC 记录分支事务状态
7. TM 请求 TC 提交全局事务
8. TC 删除快照数据和行锁
9. TC 通知 RM 提交分支事务
10. RM 确认提交
11. TC 结束全局事务
```

#### **优点**

- **无侵入性**：用户只需编写业务 SQL，无需编写额外的回滚逻辑。
- **高性能**：一阶段直接提交事务，释放数据库资源，性能较好。

#### **缺点**

- **软状态**：两阶段之间属于软状态，属于最终一致性。
- **框架影响**：框架的快照功能会影响性能，但比 XA 模式要好很多。
- 需要数据库配合新建镜像表

### **TCC 模式（Try-Confirm-Cancel）**

#### **概述**
TCC 模式是一种基于业务逻辑实现的分布式事务模式。它将一个完整交易拆分成三个阶段：预留资源（Try）、执行操作（Confirm）和取消操作（Cancel），每个阶段对应一个事务操作。

#### **工作原理**
- **Try 阶段**：进行资源的检测和预留。
- **Confirm 阶段**：确认提交，完成资源操作业务。
- **Cancel 阶段**：预留资源释放，可以理解为 Try 的反向操作。

#### 工作流程

在 Seata 中，TCC（Try-Confirm-Cancel）模式是一种高性能的分布式事务解决方案，适用于对性能要求较高且需要最终一致性的场景。与 AT 模式不同，TCC 模式需要开发者手动编写 Try、Confirm 和 Cancel 三个阶段的业务逻辑。

**1. 全局事务开始**

- **参与者**：事务管理器（TM）、事务协调者（TC）
- **操作**：
  - **TM 请求开始事务**：TM 向 TC 发起一个全局事务的请求，请求中包含事务的上下文信息。
  - **TC 生成 XID**：TC 接收到请求后，生成一个全局唯一的 XID（事务标识符），并将其返回起来。
  - **XID 传播**：TM 将 XID 传播到所有参与该事务的服务调用中。

**2. Try 阶段（尝试执行）**

- **参与者**：资源管理器（RM）
- **操作**：
  - **RM 接收 Try 请求**：每个 RM 接收到 Try 请求后，执行 Try 阶段的业务逻辑。
  - **资源预留**：RM 在 Try 阶段进行资源的预留和业务检查。例如，冻结库存、预留账户余额等，这里真正的资源并没有被更新。
  - **注册分支事务**：RM 将本地事务注册为全局事务的分支事务，并将执行结果报告给 TC。
  - **幂等性**：Try 操作必须是幂等的，即多次执行相同操作的结果应与一次执行的结果一致。

**3. Confirm 阶段（确认执行）**

- **参与者**：事务协调者（TC）、资源管理器（RM）
- **操作**：
  - **TC 确认提交**：如果所有 RM 的 Try 操作都成功，TC 决定提交全局事务。
  - **TC 通知 RM 执行 Confirm**：TC 通知所有 RM 执行 Confirm 阶段的业务逻辑。
  - **RM 执行 Confirm**：RM 接收到 Confirm 请求后，执行 Confirm 阶段的业务逻辑，完成实际的业务操作。例如，扣减库存、扣除账户余额等。
  - **幂等性**：Confirm 操作也必须是幂等的，因为可能会因为网络等原因重复执行。

**4. Cancel 阶段（取消执行）**

- **参与者**：事务协调者（TC）、资源管理器（RM）
- **操作**：
  - **TC 决定回滚**：如果任何一个 RM 的 Try 操作失败，TC 决定回滚全局事务。
  - **TC 通知 RM 执行 Cancel**：TC 通知所有 RM 执行 Cancel 阶段的业务逻辑。
  - **RM 执行 Cancel**：RM 接收到 Cancel 请求后，执行 Cancel 阶段的业务逻辑，进行资源释放和补偿操作。例如，解冻库存、恢复账户余额等。
  - **幂等性**：Cancel 操作也必须是幂等的，因为可能会因为网络等原因重复执行。

#### **优点**
- **高性能**：一阶段完成直接提交事务，释放数据库资源，性能好。
- **灵活性**：无需生成快照，无需使用全局锁，性能最强。
- **非依赖性**：不依赖数据库事务，而是依赖补偿操作，可以用于非事务型数据库。

#### **缺点**
- **代码侵入**：需要人为编写 Try、Confirm 和 Cancel 接口，太麻烦。
- **软状态**：事务是最终一致。
- **幂等处理**：需要考虑 Confirm 和 Cancel 的失败情况，做好幂等处理。

### **SAGA 模式**

#### **概述**
SAGA 模式是 Seata 提供的长事务解决方案。它将复杂的分布式事务拆分成一个个小的本地事务和补偿操作，并通过补偿操作保证整个事务的一致性。

#### **工作原理**
- **一阶段**：直接提交本地事务。
- **二阶段**：成功则什么都不做；失败则通过编写补偿业务来回滚。

#### **工作流程**

SAGA 模式将一个分布式事务拆分为一系列的本地事务（每个本地事务称为一个“子事务”），每个子事务都有对应的补偿操作（也称为“补偿事务”）。如果某个子事务失败，则通过执行之前所有已成功子事务的补偿操作来撤销整个事务的影响，从而保证最终一致性。

Seata 的 SAGA 模式通过事务管理器（TM）、事务协调者（TC）和资源管理器（RM）三个角色协同工作。

**1. 全局事务开始**

- **参与者**：事务管理器（TM）、事务协调者（TC）
- **操作**：
  - **TM 请求开始事务**：TM 向 TC 发起一个全局事务的请求，请求中包含事务的上下文信息。
  - **TC 生成 XID**：TC 接收到请求后，生成一个全局唯一的 XID（事务标识符），并将其返回给 TM。
  - **XID 传播**：TM 将 XID 传播到所有参与该事务的服务调用中。

**2. 子事务执行**

- **参与者**：事务协调者（TC）、资源管理器（RM）
- **操作**：
  - **TC 协调子事务执行**：TC 按照预定义的顺序，协调各个 RM 执行子事务。
  - **RM 执行本地事务**：每个 RM 接收到执行请求后，执行对应的本地事务操作。例如，更新数据库、调用外部服务等。
  - **状态报告**：RM 将执行结果报告给 TC。

**3. 补偿事务执行**

- **参与者**：事务协调者（TC）、资源管理器（RM）
- **操作**：
  - **TC 检测失败**：如果任何一个 RM 的子事务执行失败，TC 决定执行补偿操作。
  - **TC 通知 RM 执行补偿事务**：TC 通知所有已成功执行子事务的 RM，执行对应的补偿事务。
  - **RM 执行补偿事务**：RM 接收到补偿请求后，执行补偿操作，撤销之前本地事务的影响。例如，回滚数据库操作、撤销外部服务调用等。

**4. 最终一致性保证**

- **参与者**：事务协调者（TC）
- **操作**：
  - **TC 确认最终状态**：TC 持续跟踪所有子事务和补偿事务的执行状态，确保所有必要的补偿操作都已完成。
  - **事务结束**：一旦所有补偿操作执行完毕，TC 标记全局事务为结束状态。

#### **SAGA 模式的两种实现方式**

Seata 的 SAGA 模式支持两种实现方式：

1. **集中式协调（Centralized Coordination）**：
   - **特点**：由 TC 集中管理所有子事务和补偿事务的执行顺序和状态。
   - **优点**：实现简单，易于管理和监控。
   - **缺点**：TC 成为单点，可能成为性能瓶颈。

2. **分布式协调（Distributed Coordination）**：
   - **特点**：子事务和补偿事务的执行由各个 RM 自行协调，TC 只负责全局事务的发起和监控。
   - **优点**：减少 TC 的压力，提高系统的可扩展性和性能。
   - **缺点**：实现复杂，需要处理分布式协调的复杂性。

#### **优点**
- **高吞吐量**：事务参与者可以基于事件驱动实现异步调用，吞吐高。
- **高性能**：一阶段直接提交事务，无锁，性能好。
- **实现简单**：不用编写 TCC 中的三个阶段，实现简单。

#### **缺点**
- **软状态持续时间不确定**：时效性差。
- **无锁无隔离**：会有脏写。

### **XA 模式**

#### **概述**
XA 模式是 Seata 将会开源的另一种无侵入的分布式事务解决方案。它基于 XA 规范，描述了全局的事务管理器（TM）与局部的资源管理器（RM）之间的接口。

#### **工作原理**
- **一阶段**：RM 注册分支事务到 TC，执行分支业务 SQL 但不提交，报告执行状态到 TC。
- **二阶段**：TC 检测各分支事务执行状态。如果都成功，通知所有 RM 提交事务；如果有失败，通知所有 RM 回滚事务。

#### **工作流程**

Seata 的 XA 模式是基于 X/Open 组织提出的 XA 规范实现的分布式事务解决方案。XA 规范定义了全局事务管理器（Transaction Manager，简称 TM）和资源管理器（Resource Manager，简称 RM）之间的交互接口。Seata 的 XA 模式通过引入全局事务的概念，确保多个资源管理器（如多个数据库）在分布式环境下的一致性。

XA 模式是一种强一致性的分布式事务解决方案，它**依赖于数据库的 XA 支持**。XA 规范定义了事务管理器（TM）和资源管理器（RM）之间的交互协议，确保全局事务的原子性、一致性、隔离性和持久性（ACID 特性）。

Seata 的 XA 模式通过事务管理器（TM）、事务协调者（TC）和资源管理器（RM）三个角色协同工作。

**1. 全局事务开始**

- **参与者**：事务管理器（TM）、事务协调者（TC）
- **操作**：
  - **TM 请求开始事务**：TM 向 TC 发起一个全局事务的请求，请求中包含事务的上下文信息。
  - **TC 生成 XID**：TC 接收到请求后，生成一个全局唯一的 XID（事务标识符），并将其返回给 TM。
  - **XID 传播**：TM 将 XID 传播到所有参与该事务的服务调用中。

**2. 资源注册**

- **参与者**：事务协调者（TC）、资源管理器（RM）
- **操作**：
  - **RM 注册分支事务**：每个 RM 接收到 XID 后，将本地事务作为全局事务的分支事务注册到 TC。
  - **TC 记录分支事务**：TC 记录所有分支事务，并维护全局事务和分支事务的映射关系。

**3. 一阶段准备（Prepare Phase）**

- **参与者**：事务协调者（TC）、资源管理器（RM）
- **操作**：
  - **TC 通知 RM 准备**：TC 通知所有注册的 RM 执行一阶段准备操作。
  - **RM 执行准备操作**：RM 接收到准备请求后，执行本地事务的准备工作，但不提交事务。例如，获取必要的锁、准备数据等。
  - **RM 报告状态**：RM 将准备结果（成功或失败）报告给 TC。

**4. 二阶段提交（Commit Phase）**

- **参与者**：事务协调者（TC）、资源管理器（RM）
- **操作**：
  - **TC 决定提交**：如果所有 RM 的准备操作都成功，TC 决定提交全局事务。
  - **TC 通知 RM 提交**：TC 通知所有 RM 执行提交操作。
  - **RM 执行提交**：RM 接收到提交请求后，执行本地事务的提交操作，完成数据修改。

**5. 二阶段回滚（Rollback Phase）**

- **参与者**：事务协调者（TC）、资源管理器（RM）
- **操作**：
  - **TC 决定回滚**：如果任何一个 RM 的准备操作失败，TC 决定回滚全局事务。
  - **TC 通知 RM 回滚**：TC 通知所有 RM 执行回滚操作。
  - **RM 执行回滚**：RM 接收到回滚请求后，执行本地事务的回滚操作，撤销数据修改。

#### **XA 模式的优点**

1. **强一致性**：XA 模式遵循 ACID 原则，确保全局事务的原子性和一致性。
2. **依赖数据库支持**：利用数据库的 XA 支持，减少了应用层的复杂性。
3. **广泛支持**：大多数主流数据库（如 MySQL、Oracle、PostgreSQL）都支持 XA 规范。

#### **XA 模式的缺点**

1. **性能较低**：一阶段需要锁定数据库资源，等待二阶段结束才释放，性能较低。
2. **资源锁定时间长**：事务的持续时间较长，可能导致资源锁定时间过长，影响系统性能。
3. **依赖数据库 XA 支持**：需要数据库支持 XA 规范，且不同数据库对 XA 的实现可能存在差异。

#### **XA 模式的适用场景**

- **需要强一致性的场景**：对数据一致性要求极高的业务，如金融交易、账务处理等。
- **短事务处理**：事务执行时间较短，不会导致资源长时间锁定。
- **数据库支持 XA**：所使用的数据库支持 XA 规范，并且性能满足业务需求。

### **总结**
Seata 提供的四种分布式事务模式各有其适用场景：
- **AT 模式**：适用于不希望对业务进行改造的场景，性能较好，无代码侵入。
- **TCC 模式**：适用于对性能有很高要求的场景，但需要编写额外的代码。
- **SAGA 模式**：适用于业务流程长且需要保证事务最终一致性的业务系统。
- **XA 模式**：适用于需要强一致性的场景，但性能较低。

